import json
from core import ui
from core.tools.nvd_client import NVDClient
from core.tools.searchsploit_wrapper import search_exploitdb
from core.managers.ai_manager import AIManager

class CuratedExploitManager:
    """Manages a curated library of high-impact exploits and vulnerabilities."""

    def __init__(self):
        self.nvd_client = NVDClient()
        self.ai_manager = AIManager()
        self.curated_exploits = [] # This would ideally be persisted to DB
        ui.print_info("CuratedExploitManager initialized.")

    def _evaluate_exploit(self, exploit_data: dict, cve_details: dict) -> dict:
        """
        Uses AI to evaluate an exploit based on NVD data and Exploit-DB details.
        Returns a score or recommendation.
        """
        prompt = f"""
        You are an expert exploit analyst. Evaluate the following exploit and vulnerability data:
        - Exploit-DB Entry: {exploit_data}
        - NVD CVE Details: {cve_details}

        Based on this, provide a brief assessment (1-2 sentences) of its potential impact and reliability. Assign a score from 1 (low impact/reliability) to 10 (high impact/reliability).
        Respond in JSON format: {{'assessment': '<text>', 'score': <int>}}
        """
        assessment = self.ai_manager._call_llm(prompt, system_prompt="You are an expert exploit analyst.", task_type='analysis')
        try:
            return json.loads(assessment)
        except:
            return {'assessment': assessment, 'score': 5} # Default if AI response is not JSON

    def cherry_pick_exploit(self, cve_id: str) -> dict | None:
        """
        Searches for a CVE in NVD and Exploit-DB, then uses AI to cherry-pick the best exploit.
        """
        ui.print_info(f"Cherry-picking exploit for CVE: {cve_id}...")
        nvd_details = self.nvd_client.get_cve_details(cve_id)
        exploitdb_results = search_exploitdb(cve_id)

        if not nvd_details:
            ui.print_warning(f"No NVD details found for {cve_id}. Cannot cherry-pick.")
            return None

        if not exploitdb_results or not exploitdb_results.get('results'):
            ui.print_warning(f"No Exploit-DB entries found for {cve_id}. Cannot cherry-pick.")
            return None

        best_exploit = None
        highest_score = -1

        for exploit in exploitdb_results['results']:
            evaluation = self._evaluate_exploit(exploit, nvd_details)
            score = evaluation.get('score', 0)
            if score > highest_score:
                highest_score = score
                best_exploit = {
                    'cve_id': cve_id,
                    'nvd_details': nvd_details,
                    'exploitdb_entry': exploit,
                    'ai_assessment': evaluation
                }
        
        if best_exploit:
            self.curated_exploits.append(best_exploit)
            ui.print_success(f"Cherry-picked best exploit for {cve_id} with score {highest_score}.")
            return best_exploit
        else:
            ui.print_warning(f"Could not cherry-pick a suitable exploit for {cve_id}.")
            return None

    def get_curated_exploits(self) -> list:
        """Returns the list of currently curated exploits."""
        return self.curated_exploits
