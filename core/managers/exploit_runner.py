import subprocess
from pathlib import Path
from ..ui import UIManager

class ExploitRunner:
    """Discovers and executes Proof-of-Concept (PoC) scripts from a library."""

    def __init__(self, exploit_library_path: str, ui_manager: UIManager):
        self.library_path = Path(exploit_library_path)
        self.ui = ui_manager
        if not self.library_path.is_dir():
            raise FileNotFoundError(f"Exploit library not found at: {self.library_path}")

    def run(self, target: str) -> dict:
        """Runs all discovered exploits against a single target."""
        self.ui.run_subheading(f"Executing Exploit Library against {target}")
        exploits = self._discover_exploits()
        confirmed_vulnerabilities = {}

        if not exploits:
            self.ui.print("  -> No exploits found in the library.")
            return {}
        
        self.ui.print(f"  -> Discovered {len(exploits)} PoC scripts.")

        for exploit_path in exploits:
            exploit_name = exploit_path.stem
            self.ui.print(f"[cyan]    -> Running exploit: {exploit_name}...[/cyan]")
            success, evidence = self._run_single_exploit(target, exploit_path)
            if success:
                self.ui.print(f"[bold green]    -> SUCCESS: {exploit_name} confirmed![/bold green]")
                confirmed_vulnerabilities[exploit_name] = {
                    'evidence': evidence,
                    'script': str(exploit_path)
                }

        return confirmed_vulnerabilities

    def _discover_exploits(self) -> list[Path]:
        """Finds all Python PoC scripts in the library."""
        return list(self.library_path.rglob('*.py'))

    def _run_single_exploit(self, target: str, script_path: Path) -> tuple[bool, str]:
        """Executes a single PoC script in a subprocess."""
        try:
            # We assume the PoC script takes the target URL as the first argument
            result = subprocess.run(
                ['python3', str(script_path), target],
                capture_output=True,
                text=True,
                check=True, # This will raise an error if the script exits with non-zero
                timeout=30 # Prevent long-running scripts
            )
            output = result.stdout.strip()
            if output.startswith("SUCCESS:"):
                return True, output
            return False, output
        except subprocess.TimeoutExpired:
            return False, "PoC script timed out."
        except subprocess.CalledProcessError as e:
            return False, f"PoC script failed or did not find a vulnerability. Output:\n{e.stdout}\n{e.stderr}"
        except Exception as e:
            return False, f"An unexpected error occurred while running exploit: {e}"

